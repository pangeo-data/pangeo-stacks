language: python

services:
  - docker

notifications:
  email: false

python:
  - "3.6"

env:
  matrix:
    - IMAGE=base-notebook
    - IMAGE=pangeo-notebook
  global:
    - DOCKER_ID=pangeo
    - CALVER="$( date '+%Y.%m.%d' )"

install:
  # pinned r2d version to fix conda install problems
  - pip install git+git://github.com/jupyter/repo2docker.git@9766c9545540fb3e461c6ea92b054dbb3cb90184
  - repo2docker --version
  - docker version

before_script:
  - IMAGE_NAME=${DOCKER_ID}/${IMAGE}:${CALVER}
  - echo "Building ${IMAGE_NAME}"
  - repo2docker --no-run --user-name=jovyan --user-id 1000 --appendix="`cat appendix.txt`" --image-name=${IMAGE_NAME} ./${IMAGE}
  - echo "Done building ${IMAGE_NAME}"

script:
  - docker run -d --name pangeo ${IMAGE_NAME}
  - docker exec -it pangeo bash -c 'pip install pytest; py.test -v tests/*.py'

deploy:
  provider: script
  script: bash docker_push.sh
  on:
    branch: master
